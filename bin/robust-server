#!/bin/sh
# Copyright 2023 RobustMQ Team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# help info
usage() {
    echo "Usage: $0 <action> [config_file]"
    echo "  action: start | stop"
    echo "  config_file: optional, default is config/server.toml"
    echo "  example start: $0 start config/server.toml"
    echo "  example stop: $0 stop"
    exit 1
}


# check args
[ $# -lt 1 ] && usage


workdir=$(cd $(dirname $0); pwd)
mkdir -p ${workdir}/../logs
action=$1
conf=$2

# check action
case "${action}" in
    start|stop) ;;
    *) echo "Invalid action: ${action}, optional: start, stop"; usage ;;
esac

[ -z $conf ] && conf=${workdir}/../config/server.toml
log_file=${workdir}/../logs/robustmq.log
# Get absolute path for cleaner display
log_file_abs=$(cd "$(dirname "${log_file}")" && pwd)/$(basename "${log_file}")

start_service() {
  local bin_path="${workdir}/../libs/broker-server"
  [ ! -x "$bin_path" ] && echo "ERROR: $bin_path not found or not executable" && exit 1
  [ ! -f $conf ] && echo "Config file not found: $conf" && exit 1

  # Raise the open file descriptor limit to handle large numbers of
  # MQTT connections and gRPC channels without hitting "Too many open files".
  # Only affects this process and its children; no root privilege required
  # as long as the requested value does not exceed the system hard limit.
  local fd_limit=20000000
  if ulimit -n "${fd_limit}" 2>/dev/null; then
    echo "ğŸ“Œ File descriptor limit set to ${fd_limit}"
  else
    # Requested value exceeds the hard limit; fall back to the hard limit.
    local hard_limit
    hard_limit=$(ulimit -Hn 2>/dev/null || echo "")
    local fallback_limit=1000000
    if [ -n "${hard_limit}" ] && [ "${hard_limit}" != "unlimited" ] && ulimit -n "${hard_limit}" 2>/dev/null; then
      echo "ğŸ“Œ File descriptor limit set to hard limit: ${hard_limit}"
      echo "   (To raise further, set in /etc/security/limits.conf and relogin:)"
      echo "     * soft nofile ${fd_limit}"
      echo "     * hard nofile ${fd_limit}"
    elif ulimit -n "${fallback_limit}" 2>/dev/null; then
      echo "ğŸ“Œ File descriptor limit set to fallback: ${fallback_limit}"
    else
      echo "âš ï¸  Could not adjust file descriptor limit (current: $(ulimit -n 2>/dev/null || echo unknown))."
    fi
  fi

  echo "Config: $conf"
  echo "Starting RobustMQ broker server..."
  nohup "${bin_path}" --conf="${conf}" >> "${log_file}" 2>&1 &
  sleep 3
  # shellcheck disable=SC2006
  num=` ps -ef | grep /libs/broker-server | grep -v grep | wc -l`
  if [ $num -ge 1 ]
  then
    echo "âœ… RobustMQ broker started successfully."
    echo "ğŸ“ Log file location: ${log_file_abs}"
    echo "ğŸ“ To view logs in real-time: tail -f \"${log_file_abs}\""
    echo "ğŸ” To check service status: ps -ef | grep broker-server"
    echo "ğŸ’¡ Log directory: $(dirname "${log_file_abs}")"
  else
    echo "âŒ WARN: broker started failure. please check detail in ${log_file_abs}"
    echo "ğŸ“ Error log location: ${log_file_abs}"
  fi

}

stop_service() {
  no=$(ps -ef | grep "broker-server" | grep conf | grep -v grep | awk '{print $2}')
  [ ! -n "$no" ] && echo "â„¹ï¸  No running processes found for broker-server." && exit 0
  echo "ğŸ” Currently running process numbers: $no"
  echo "ğŸ›‘ Stopping RobustMQ broker server..."
  for pid in $no; do
    echo "   Killing process: $pid"
    kill "$pid"
  done
  sleep 3
  num=$(ps -ef | grep "/libs/broker-server" | grep conf | grep -v grep | wc -l)
  if [ "$num" -eq 0 ]; then
    echo "âœ… RobustMQ broker stopped successfully."
    echo "ğŸ“ Final logs available at: ${log_file_abs}"
    echo "ğŸ“ To view shutdown logs: tail -n 50 \"${log_file_abs}\""
    echo "ğŸ’¡ Log directory: $(dirname "${log_file_abs}")"
  else
    echo "âŒ WARN: broker stop failure."
    echo "ğŸ“ Check logs for details: ${log_file_abs}"
    echo "ğŸ”§ Try manual cleanup: kill -9 \$(ps -ef | grep broker-server | awk '{print \$2}')"
  fi
}


case "${action}" in
    start) start_service ;;
    stop)  stop_service ;;
esac
