#!/bin/sh
# Copyright 2023 RobustMQ Team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# help info
usage() {
    echo "Usage: $0 <action> [config_file]"
    echo "  action: start | stop"
    echo "  config_file: optional, default is config/<module>.toml"
    echo "  example start: $0 start config/placement-center.toml"
    echo "  example stop: $0 stop"
    exit 1
}


# check args
[ $# -lt 1 ] && usage


workdir=$(cd $(dirname $0); pwd)
mkdir -p ${workdir}/../logs
action=$1
conf=$2

# check action
case "${action}" in
    start|stop) ;;
    *) echo "Invalid action: ${action}, optional: start, stop"; usage ;;
esac

[ -z $conf ] && conf=${workdir}/../config/server.toml
log_file=${workdir}/../logs/nohup.log

start_service() {
  local bin_path="${workdir}/../libs/broker-server"
  [ ! -x "$bin_path" ] && echo "ERROR: $bin_path not found or not executable" && exit 1
  [ ! -f $conf ] && echo "Config file not found: $conf" && exit 1
  echo "Config:$conf"
  nohup "${bin_path}" --conf="${conf}" >> "${log_file}" 2>&1 &
  sleep 3
  num=` ps -ef | grep /libs/broker-server | grep -v grep | wc -l`
  if [ $num -ge 1 ]
  then
    echo "broker started successfully."
  else
    echo "WARN: broker started failure. please check detail in ${log_file}"
  fi

}

stop_service() {
  no=$(ps -ef | grep "broker-server" | grep conf | grep -v grep | awk '{print $2}')
  [ ! -n "$no" ] && echo "No running processes found for broker-server." && exit 0
  echo "Currently running process numbers: $no"
  for pid in $no; do
    echo "Killing process: $pid"
    kill "$pid"
  done
  sleep 3
  num=$(ps -ef | grep "/libs/broker-server" | grep conf | grep -v grep | wc -l)
  if [ "$num" -eq 0 ]; then
    echo "broker stopped successfully."
  else
    echo "WARN: broker stop failure."
  fi
}


case "${action}" in
    start) start_service ;;
    stop)  stop_service ;;
esac
