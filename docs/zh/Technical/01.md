# Multi Raft 设计方案

> **设计原则**：单 RocksDB 实例，少量 Column Family，按 Key 前缀来区分 Raft State Machine，基于扫描自定义生成快照。

## 一、Meta Service 存储数据规划

Meta Service 预计规划存储下面三类数据：

### 1.1 集群相关元数据（小数据量）
- MQTT 相关业务元数据
- Kafka 相关业务元数据
- 集群配置信息

### 1.2 MQTT 相关大量数据
- **Session**：MQTT 客户端会话信息
- **LastWill**：遗嘱消息数据
- **RetainMessage**：保留消息数据

### 1.3 Offset 相关数据
- Consumer Offset 数据
- 消费进度信息

### 1.4 状态机规划

对应上述数据分类，在第一阶段规划三个状态机来处理这三种场景：

1. **Metadata State Machine**：存储集群相关元数据
2. **MQTT State Machine**：存储 MQTT 相关元数据
   - Session
   - Last Will
   - Retain Message
3. **Offset State Machine**：存储消费偏移量数据

## 二、Multi Raft 架构

![Multi Raft 架构图](../../images/multi-raft.png)

### 2.1 架构概述

在 Meta Service 中，当前有三个 Raft State Machine（可根据需要扩展），分别是 Metadata、MQTT、Offset。

### 2.2 多状态机的优势

多状态机架构的核心优势在于：

- **隔离性**：不同的状态机在网络层面的通信和 Raft 一致性同步不会相互影响
- **性能**：Metadata 的操作、Offset 的操作、MQTT 相关的元数据操作互不阻塞
- **可扩展性**：可以根据业务需求灵活增加新的状态机

### 2.3 存储层设计

存储层共用一个 RocksDB 实例，实例中分为多个 Column Family：

- **Raft Column Family**：负责多个 Raft State Machine 相关 log 和 state 的存储
  - `logs`：Raft 日志条目
  - `store`：Raft 状态信息（vote、committed、last_purged_log_id 等）
- **Data Column Family**（规划中）：负责 KV 和大数据量数据的存储
  - Session、LastWill、RetainMessage、Offset 等数据的存储
- **Metadata Column Family**（规划中）：负责集群相关的元数据存储
  - 小数据量的集群配置和元数据

## 三、技术路线

### 3.1 存储层 Key 规划

#### 3.1.1 Raft 相关

**Column Family: `logs` 和 `store`**

**Key 规划**：
```
/metadata/raft/log/{log_index}
/metadata/raft/store/{key}
/offset/raft/log/{log_index}
/offset/raft/store/{key}
/mqtt/raft/log/{log_index}
/mqtt/raft/store/{key}
```

**说明**：
- `{log_index}`：日志条目的索引（8 字节大端序编码）
- `{key}`：Raft 状态键（如 `vote`、`committed`、`last_purged_log_id`）

#### 3.1.2 Metadata Column Family（规划中）

**Column Family: `metadata`**

**Key 规划**：
```
/metadata/cluster/{key}
/metadata/mqtt/{key}
/metadata/kafka/{key}
```

**说明**：
- 用于存储集群配置、协议相关的小数据量元数据
- Key 格式：`/{namespace}/{type}/{specific_key}`

#### 3.1.3 Data Column Family（规划中）

**Column Family: `data`**

**Key 规划**：
```
/mqtt/session/{client_id}
/mqtt/lastwill/{client_id}
/mqtt/retain/{topic}
/mqtt/subscribe/{client_id}/{topic}
/mqtt/acl/{principal}
/offset/{group_id}/{topic}/{partition}
```

**说明**：
- 用于存储大数据量的业务数据
- Key 格式：`/{state_machine}/{data_type}/{identifier}`

### 3.2 快照生成策略

- 基于 Key 前缀扫描生成快照
- 每个状态机独立生成快照
- 支持增量快照（规划中）

### 3.3 性能优化

- **批量写入**：使用 `WriteBatch` 批量写入日志条目
- **序列化优化**：使用 `bincode` 进行高效序列化
- **缓冲区复用**：网络层序列化使用可复用缓冲区
- **错误处理**：统一的错误处理和上下文信息
