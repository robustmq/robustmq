## MQTT 数据订阅

MQTT 订阅是指MQTT 客户端通过 Subscribe 命令字来订阅Broker 中 Topic 的数据。客户端可以通过指定 Topic 或通配符来指定需要订阅的 Topic。从功能来看，MQTT 的订阅分为直接订阅和共享订阅。

### 直接订阅和共享订阅
直接订阅是指客户端直接通过指定 Topic 或通配符来订阅 Topic 中的数据。也就是说以ClientId + Topic 维度订阅数据。此时 Topic 收到数据后会按顺序推送给ClientId。也就是说这个ClientId对应的客户端会收到Topic中的所有数据。

共享订阅是指客户端通过指定 Topic 或通配符来订阅 Topic 中的数据时，会指定一个GroupName。此时会以GroupName 来组织所有的客户端。共享订阅的订阅格式如下所示：
```
$share/consumer1/sport/tennis/+
$share/consumer2/sport/tennis/+
$share/consumer1/sport/#
$share/comsumer1/finance/#
```
注意两个订阅的共享名 {Share Name} 相同，并不表示它们一定是相同的共享订阅。只有 {Share Name}/{Topic Filter} 才能唯一地标识一个共享订阅组，上面这些订阅主题均属于不同的共享订阅组。

也就是说 {Share Name}/{Topic Filter} 能匹配到的所有Topic的数据，会被均匀分发给多个客户端。

因此从技术上来看，直接订阅和共享订阅的推送机制实现是不一样的。

### 技术挑战
从特征上看，MQTT 订阅有下面四个特点：
1. 可能会有大量客户端订阅某个Topic。比如在物联网数据采集的场景中，每个传感器都需要上报数据&监听下发的指令，因此可能会有比如几十万，上百万个客户端监听某个Topic。
2. 一个客户端可能订阅很多歌Topic。MQTT 订阅支持通配符订阅，也就是说极端情况下可能一个客户端订阅所有Topic，比如集群有几千个Topic甚至更多，因此一个客户端可能订阅几千甚至更多的Topic。
3. MQTT的客户端可能大多存在弱网环境下，可能频繁的上线下线。也就是说推送订阅数据的时候，可能会出现推送订阅数据耗时增加或推送失败的情况。
4. MQTT 订阅的数据推送需要尽量保证数据的及时性。

所以，从技术上看，订阅数据推送的要求是： 及时性、成功率、且不能因为客户端或者单个客户端订阅的Topic的线性增加而线性增加系统的压力。也就是说不管任何情况下，需要保证下面三点：
1. 需要保证系统的压力的平稳的
2. 推送数据要及时
3. 需要保证推送的成功率



### 推送模型思考
流程上看，订阅就是将数据从存储层读出来，然后发送给 MQTT 客户端。从技术上看，核心就是订阅推送的线程模型，也就是说是一个客户端一个订阅推送线程，还是多个客户端一个订阅推送线程，还是一个客户端多个订阅推送线程，还是一个topic 一个订阅推送线程。不同的推送模型最大的考虑是如下三个点：
1. 推送线程是否会膨胀，能够固定在一个量级。
2. MQTT 客户端经常上下线，如果客户端经常上下线收不到消息会怎么处理。
3. 有的 MQTT 客户端客户端网络环境差，推送消息慢，如果一个线程推送给多个客户端，那某个客户端慢，是不是会影响其他客户端的推送及时性。

在第一个版本中，直接订阅我们是以client_id + topic 二元组为维度推送数据的。技术上就是一个 client_id + topic一个 Tokio Task 为维度推送数据。它的优点是每个client_id订阅每个Topic相互独立，不同订阅间隔离性强，可以完美解决2和3点问题。缺点是当订阅数量上升时，tokio task 会极速膨胀，从而导致 tokio task 产生性能问题，从而影响内核的性能。

### 两种推送模型
从技术上看，隔离性和tokio task膨胀
1. ClientId： 一个Client ID 一个推送线程，不管订阅了多少个Topic，一个Client ID 就由一个推送线程来执行推送。最大的缺点是，比如ClientId 到达上千万/亿时，一台节点上百万时，一台节点就要几百万个tokio task吗。 这个显然是不可行的。
2. ClientID + Topic： 以Client Id + Topic 为维度制定推送线程，推送粒度更细。也就是说一个ClientId可能会有N个推送线程。虽然隔离性个好，但是Tokio task的膨胀粒度比第一种更膨胀。基本也是不可行的。

这里可以总结，以 ClientId 维度的推送模型，在有大量客户端的场景，基本是行不通的。只有在客户端数量可控的维度才可以行得通。

另外，在实际的场景中 MQTT 的推送及时性要求没想象中那么高。所以，为了控制Tokio Task的膨胀。我们以Topic为维度来设计订阅模型，结构如下：
![img](../../images/push-thread-model.png)

如上图所示：推送
