# RobustMQ é…ç½®æ–‡ä»¶é€šç”¨æŒ‡å—

## æ¦‚è¿°

RobustMQ ä½¿ç”¨ TOML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥ç®¡ç†ç³»ç»Ÿé…ç½®ã€‚é…ç½®æ–‡ä»¶ä½äº `config/` ç›®å½•ä¸‹ï¼Œä¸»è¦é…ç½®æ–‡ä»¶ä¸º `server.toml`ã€‚

## é…ç½®æ–‡æ¡£å¯¼èˆª

- ğŸ”§ **[MQTT é…ç½®](MQTT.md)** - MQTT Broker ç›¸å…³é…ç½®
- ğŸ—ï¸ **[Meta é…ç½®](META.md)** - å…ƒæ•°æ®æœåŠ¡é…ç½®
- ğŸ“ **[Journal é…ç½®](JOURNAL.md)** - æ—¥å¿—å¼•æ“é…ç½®

---

## é…ç½®æ–‡ä»¶ç»“æ„

### ä¸»é…ç½®æ–‡ä»¶
- **`config/server.toml`** - ä¸»è¦é…ç½®æ–‡ä»¶
- **`config/server.toml.template`** - é…ç½®æ¨¡æ¿æ–‡ä»¶
- **`config/server-tracing.toml`** - æ—¥å¿—è¿½è¸ªé…ç½®

### é…ç½®åŠ è½½ä¼˜å…ˆçº§
1. å‘½ä»¤è¡Œå‚æ•°
2. ç¯å¢ƒå˜é‡
3. é…ç½®æ–‡ä»¶
4. é»˜è®¤å€¼

---

## åŸºç¡€é…ç½®

### é›†ç¾¤åŸºç¡€ä¿¡æ¯
```toml
# é›†ç¾¤åç§°
cluster_name = "robust_mq_cluster_default"

# èŠ‚ç‚¹ ID
broker_id = 1

# èŠ‚ç‚¹è§’è‰²
roles = ["meta", "broker", "journal"]

# gRPC ç«¯å£
grpc_port = 1228

# HTTP ç«¯å£
http_port = 8080

# å…ƒæ•°æ®ä¸­å¿ƒåœ°å€
[meta_addrs]
1 = "127.0.0.1:1228"
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `cluster_name` | `string` | `"robust_mq_cluster_default"` | é›†ç¾¤åç§°ï¼Œé›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ç›¸åŒ |
| `broker_id` | `u64` | `1` | èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ç¬¦ |
| `roles` | `array` | `["meta", "broker"]` | èŠ‚ç‚¹è§’è‰²ï¼šmeta(å…ƒæ•°æ®)ã€broker(MQTT)ã€journal(æ—¥å¿—) |
| `grpc_port` | `u32` | `1228` | gRPC æœåŠ¡ç«¯å£ |
| `http_port` | `u32` | `8080` | HTTP API æœåŠ¡ç«¯å£ |
| `meta_addrs` | `table` | `{1 = "127.0.0.1:1228"}` | å…ƒæ•°æ®ä¸­å¿ƒèŠ‚ç‚¹åœ°å€æ˜ å°„ |

---

## è¿è¡Œæ—¶é…ç½®

### Runtime é…ç½®
```toml
[runtime]
runtime_worker_threads = 4    # è¿è¡Œæ—¶å·¥ä½œçº¿ç¨‹æ•°
tls_cert = "./config/certs/cert.pem"  # TLS è¯ä¹¦è·¯å¾„
tls_key = "./config/certs/key.pem"    # TLS ç§é’¥è·¯å¾„
```

### Network é…ç½®
```toml
[network]
accept_thread_num = 1         # æ¥å—è¿æ¥çº¿ç¨‹æ•°
handler_thread_num = 1        # å¤„ç†çº¿ç¨‹æ•°
response_thread_num = 1       # å“åº”çº¿ç¨‹æ•°
queue_size = 1000            # é˜Ÿåˆ—å¤§å°
lock_max_try_mut_times = 30   # é”æœ€å¤§å°è¯•æ¬¡æ•°
lock_try_mut_sleep_time_ms = 50  # é”å°è¯•ç¡çœ æ—¶é—´(æ¯«ç§’)
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `runtime_worker_threads` | `usize` | è‡ªåŠ¨æ£€æµ‹ | Tokio è¿è¡Œæ—¶å·¥ä½œçº¿ç¨‹æ•° |
| `tls_cert` | `string` | `"./config/certs/cert.pem"` | TLS è¯ä¹¦æ–‡ä»¶è·¯å¾„ |
| `tls_key` | `string` | `"./config/certs/key.pem"` | TLS ç§é’¥æ–‡ä»¶è·¯å¾„ |
| `accept_thread_num` | `usize` | `1` | æ¥å—æ–°è¿æ¥çš„çº¿ç¨‹æ•° |
| `handler_thread_num` | `usize` | `1` | å¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ•° |
| `response_thread_num` | `usize` | `1` | å‘é€å“åº”çš„çº¿ç¨‹æ•° |
| `queue_size` | `usize` | `1000` | å†…éƒ¨é˜Ÿåˆ—å¤§å° |

---

## å­˜å‚¨é…ç½®

### RocksDB é…ç½®
```toml
[rocksdb]
data_path = "./data"          # æ•°æ®å­˜å‚¨è·¯å¾„
max_open_files = 10000       # æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `data_path` | `string` | `"./data"` | RocksDB æ•°æ®å­˜å‚¨ç›®å½• |
| `max_open_files` | `i32` | `10000` | RocksDB æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•° |

---

## ç›‘æ§é…ç½®

### Prometheus é…ç½®
```toml
[prometheus]
enable = true                 # æ˜¯å¦å¯ç”¨ Prometheus æŒ‡æ ‡
port = 9090                  # Prometheus æŒ‡æ ‡ç«¯å£
```

### PProf é…ç½®
```toml
[p_prof]
enable = false               # æ˜¯å¦å¯ç”¨æ€§èƒ½åˆ†æ
port = 6060                 # PProf æœåŠ¡ç«¯å£
frequency = 100             # é‡‡æ ·é¢‘ç‡
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `prometheus.enable` | `bool` | `true` | æ˜¯å¦å¯ç”¨ Prometheus æŒ‡æ ‡æ”¶é›† |
| `prometheus.port` | `u32` | `9090` | Prometheus æŒ‡æ ‡æš´éœ²ç«¯å£ |
| `p_prof.enable` | `bool` | `false` | æ˜¯å¦å¯ç”¨ PProf æ€§èƒ½åˆ†æ |
| `p_prof.port` | `u16` | `6060` | PProf æœåŠ¡ç«¯å£ |
| `p_prof.frequency` | `i32` | `100` | PProf é‡‡æ ·é¢‘ç‡ |

---

## æ—¥å¿—é…ç½®

### Log é…ç½®
```toml
[log]
log_config = "./config/server-tracing.toml"  # æ—¥å¿—é…ç½®æ–‡ä»¶è·¯å¾„
log_path = "./data/broker/logs"              # æ—¥å¿—è¾“å‡ºç›®å½•
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `log_config` | `string` | `"./config/broker-tracing.toml"` | æ—¥å¿—è¿½è¸ªé…ç½®æ–‡ä»¶è·¯å¾„ |
| `log_path` | `string` | `"./logs"` | æ—¥å¿—æ–‡ä»¶è¾“å‡ºç›®å½• |

---

## ç¯å¢ƒå˜é‡è¦†ç›–

RobustMQ æ”¯æŒä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®ã€‚ç¯å¢ƒå˜é‡å‘½åè§„åˆ™ï¼š

### å‘½åè§„åˆ™
```
{PREFIX}_{SECTION}_{KEY}
```

### ç¤ºä¾‹
```bash
# è¦†ç›–é›†ç¾¤åç§°
export ROBUSTMQ_CLUSTER_NAME="my-cluster"

# è¦†ç›– MQTT TCP ç«¯å£
export ROBUSTMQ_MQTT_SERVER_TCP_PORT=1884

# è¦†ç›–æ—¥å¿—è·¯å¾„
export ROBUSTMQ_LOG_LOG_PATH="/var/log/robustmq"

# è¦†ç›– Prometheus ç«¯å£
export ROBUSTMQ_PROMETHEUS_PORT=9091
```

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§
ç¯å¢ƒå˜é‡çš„å€¼ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„å¯¹åº”è®¾ç½®ï¼Œä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ã€‚

---

## é…ç½®æ–‡ä»¶ç¤ºä¾‹

### åŸºæœ¬é…ç½®ç¤ºä¾‹
```toml
# åŸºç¡€é…ç½®
cluster_name = "production-cluster"
broker_id = 1
roles = ["meta", "broker"]
grpc_port = 1228

# å…ƒæ•°æ®ä¸­å¿ƒåœ°å€
[meta_service]
1 = "192.168.1.10:1228"
2 = "192.168.1.11:1228"
3 = "192.168.1.12:1228"

# è¿è¡Œæ—¶é…ç½®
[runtime]
runtime_worker_threads = 8
tls_cert = "./config/certs/prod-cert.pem"
tls_key = "./config/certs/prod-key.pem"

# ç½‘ç»œé…ç½®
[network]
accept_thread_num = 4
handler_thread_num = 8
response_thread_num = 4
queue_size = 2000

# å­˜å‚¨é…ç½®
[rocksdb]
data_path = "/data/robustmq"
max_open_files = 20000

# ç›‘æ§é…ç½®
[prometheus]
enable = true
port = 9090

# æ—¥å¿—é…ç½®
[log]
log_config = "./config/production-tracing.toml"
log_path = "/var/log/robustmq"
```

---

## é…ç½®éªŒè¯

### é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥
```bash
# æ£€æŸ¥ TOML è¯­æ³•
cargo run --bin config-validator config/server.toml
```

### å¸¸è§é…ç½®é”™è¯¯
1. **TOML è¯­æ³•é”™è¯¯** - ç¼ºå°‘å¼•å·ã€æ‹¬å·ä¸åŒ¹é…ç­‰
2. **ç«¯å£å†²çª** - å¤šä¸ªæœåŠ¡ä½¿ç”¨ç›¸åŒç«¯å£
3. **è·¯å¾„ä¸å­˜åœ¨** - è¯ä¹¦æ–‡ä»¶ã€æ—¥å¿—ç›®å½•ä¸å­˜åœ¨
4. **æƒé™é—®é¢˜** - æ•°æ®ç›®å½•æ²¡æœ‰å†™æƒé™

---

## æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®
1. **å®‰å…¨æ€§**:
   - ä½¿ç”¨å¼ºå¯†ç å’Œè¯ä¹¦
   - é™åˆ¶ç½‘ç»œè®¿é—®æƒé™
   - å¯ç”¨ TLS åŠ å¯†

2. **æ€§èƒ½ä¼˜åŒ–**:
   - æ ¹æ®ç¡¬ä»¶é…ç½®è°ƒæ•´çº¿ç¨‹æ•°
   - åˆç†è®¾ç½®é˜Ÿåˆ—å¤§å°
   - ä¼˜åŒ–å­˜å‚¨è·¯å¾„é…ç½®

3. **ç›‘æ§å’Œæ—¥å¿—**:
   - å¯ç”¨ Prometheus ç›‘æ§
   - é…ç½®åˆé€‚çš„æ—¥å¿—çº§åˆ«
   - è®¾ç½®æ—¥å¿—è½®è½¬ç­–ç•¥

4. **é«˜å¯ç”¨æ€§**:
   - é…ç½®å¤šä¸ªå…ƒæ•°æ®ä¸­å¿ƒèŠ‚ç‚¹
   - è®¾ç½®åˆé€‚çš„å¿ƒè·³è¶…æ—¶æ—¶é—´
   - é…ç½®æ•°æ®å¤‡ä»½ç­–ç•¥

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **é…ç½®åŠ è½½å¤±è´¥** - æ£€æŸ¥ TOML è¯­æ³•å’Œæ–‡ä»¶è·¯å¾„
2. **ç«¯å£ç»‘å®šå¤±è´¥** - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
3. **è¯ä¹¦åŠ è½½å¤±è´¥** - æ£€æŸ¥è¯ä¹¦æ–‡ä»¶è·¯å¾„å’Œæ ¼å¼
4. **å­˜å‚¨åˆå§‹åŒ–å¤±è´¥** - æ£€æŸ¥æ•°æ®ç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

### è°ƒè¯•æ–¹æ³•
1. å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º
2. æ£€æŸ¥é…ç½®åŠ è½½æ—¥å¿—
3. ä½¿ç”¨é…ç½®éªŒè¯å·¥å…·
4. æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*æœ€åæ›´æ–°: 2024-01-01*
*åŸºäºä»£ç ç‰ˆæœ¬: RobustMQ v0.1.31*
