# Copyright 2023 RobustMQ Team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Close Issues on Merge

on:
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: read

jobs:
  close-issues:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
    - name: Close Issues
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const prBody = pr.body || '';
          
          // Extract issue numbers from PR body (supports: close #123, closes #123, fix #123, fixes #123, resolve #123, resolves #123)
          const issueRefs = prBody.match(/(?:close|closes|fix|fixes|resolve|resolves)\s+#(\d+)/gi);
          
          if (issueRefs) {
            for (const ref of issueRefs) {
              const issueNumber = parseInt(ref.match(/#(\d+)/)[1]);
              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
                console.log(`Closed issue #${issueNumber}`);
              } catch (error) {
                console.log(`Failed to close issue #${issueNumber}: ${error.message}`);
              }
            }
          }